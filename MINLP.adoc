:encoding: utf-8
:imagesdir: img
:cpp: C++

== Solving Mixed Integer Problems

What if some of the variables of our optimization problem are restricted to be integers
(see https://github.com/dietmarwo/fast-cma-es/blob/master/examples/gear_train.py[gear_train.py]) - or
are integer multiples of some real value (see https://github.com/dietmarwo/fast-cma-es/blob/master/examples/vessel.py[vessel.py])?

We could define all variables as continuous and map these to the nearest feasible value as done in both examples above. The vessel example has shown, that we have to be careful when using an optimizer
which utilizes derivatives - since this mapping destroys the smoothness of the objective function. 
But luck is on our side, all fcmaes optimizers are derivative-free. So we don't expect 
problems here. To verify this assumption, lets analyze a non-trivial example:

Here http://www.midaco-solver.com/index.php/about/benchmarks/gtopx[Midaco/GTOPX] we find 
the example Cassini1-MINLP. As the name indicates, this is not a linear programming problem, 
the objective function is not linear. MILP (Mixed Integer Linear Programming) problems with linear
objective functions are easy to solve and require different algorithms to maximize efficiency. 

It is recommended to read http://www.midaco-solver.com/data/pub/CEC2019_Schlueter_Munetomo.pdf[CEC2019]
first, it contains a detailed description of the problem:

We have mentioned the https://www.esa.int/gsp/ACT/projects/gtop/cassini1/[Cassini] problem already in 
https://github.com/dietmarwo/fast-cma-es/blob/master/Results.adoc[Results] and https://github.com/dietmarwo/fast-cma-es/blob/master/PYKEP.adoc[Pykep gym results], Cassini1-MINLP is an extension of this benchmark. The original https://solarsystem.nasa.gov/missions/cassini/overview/[Cassini Mission]
to Saturn involved four gravity-assists at Venus, Venus, Earth and Jupiter to save fuel. 

Cassini1-MINLP now adds four variables performing the decision which planets to use for the four flybys. Nasa/JPL has shown limited "intuition" choosing a planet sequence for the https://sophia.estec.esa.int/gtoc_portal/?page_id=13[GTOC1 competition] as we have seen in the last section of https://github.com/dietmarwo/fast-cma-es/blob/master/Tutorial.adoc[Tutorial]. Better tools could assist "intuition" and could simplify mission planning. 

The authors of http://www.midaco-solver.com/data/pub/CEC2019_Schlueter_Munetomo.pdf[CEC2019] are right: If we find a better planet sequence for Cassini this could be caused by flaws in the model. Allowing deep space maneuvers between planets as in https://www.esa.int/gsp/ACT/projects/gtop/cassini2/[Cassini2] could help. Additionally the final flyby at Jupiter probably was required because it is of significant scientific value. 

==== Cassini1-MINLP

image::cassini.png[]

From http://www.midaco-solver.com/data/pub/CEC2019_Schlueter_Munetomo.pdf[CEC2019] : 
"The general MINLP formulation of Cassini1 remains yet intractable
and therefore appears to be even more difficult
than the hardest continuous instance from the entire
GTOP database, which is the Messenger (full version) benchmark. The difficulty of this particular MINLP
instance appears to arise from a very decisive local
optimum, which prevents the optimization algorithm
from reaching the global optimal integer sequence"

So we expect a real challenge.

To ensure comparability of the results we use the same Cassini1-MINLP code from http://www.midaco-solver.com/data/gtopx/cpp/gtopx.cpp . We copied also the original bounds to 
https://github.com/dietmarwo/fast-cma-es/blob/master/fcmaes/astro.py[astro.py]:

----
	lb = [-1000.,30.,100.,30.,400.,1000., 1.0,1.0,1.0,1.0 ],
	ub = [0.,400.,470.,400.,2000.,6000., 9.0,9.0,9.0,9.0 ]       
----
Usually we recommend to assign the same continuous interval to each discrete value. As defined here, since the mapping is done using the `round` operation, Mercury and Pluto only get a 0.5-wide interval, all other planets have a 1.0-wide one.

==== Intractability

How did http://www.midaco-solver.com/data/pub/CEC2019_Schlueter_Munetomo.pdf[CEC2019]  
conclude that Cassini1-MINLP is "intractable"? They first identified the individual
best global optimal solutions corresponding to different planet
sequences, of which there are 9^4 = 6561 possible combinations. Then they checked if the best
combination is found by their Ant Colony Optimization based MINLP solver. 

They found the sequence Earth, Venus, Earth, Jupiter with deltaV = 3.507 to be optimal which is superior to the original sequence Venus, Venus, Earth, Jupiter with deltaV = 4.9307. 

==== Applying the coordinated retry

Lets apply fcmaes coordinated retry using the default optimizer `de_cma` (see https://github.com/dietmarwo/fast-cma-es/blob/master/examples/cassini_minlp.py[cassini_minlp.py]):

[source,python]
----
from fcmaes.astro import Cassini1minlp
from fcmaes.optimizer import logger
from fcmaes.advretry import minimize

def _test_optimizer(problem, num_retries = 120000, num = 100, value_limit = 100.0, log = logger()):
    log.info(problem.name + ' ' + opt.name)
    for i in range(num):
        ret = minimize(problem.fun, problem.bounds, value_limit, num_retries, log)

_test_optimizer(Cassini1minlp()) 
----

We set `num_retries = 120000` because we expect the problem to be hard to solve. 
We execute the code on an AMD 3950x 16 core processor at 4.0GHZ. 

Initially we missed the rp4 > 671492 km equality constraint - which by the way 
makes no sense for an arbitrary 4th flyby planet, it is specifically defined for Jupiter. At this distance there
is no gravity assist at smaller planets. But for comparability we now also enforce the four inequality constraints - and can confirm that the deltaV = 3.507 is optimal and hard to find. 

Detailed results will be uploaded soon. 
